name: Publish Release

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  release:
    name: Tag and Release
    runs-on: ubuntu-latest
    steps:
      - name: Extract version from head commit
        id: version
        uses: actions/github-script@v7
        with:
          script: |
            const message = context.payload.head_commit?.message ?? "";
            const match = message.match(/v\d+\.\d+\.\d+/);
            if (!match) {
              core.info("No version pattern (vX.Y.Z) in head commit message; skipping.");
              return;
            }
            const version = match[0];
            core.setOutput("version", version);
            core.info(`Detected release version ${version}`);

      - name: Checkout repository
        if: steps.version.outputs.version
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create lightweight tag
        if: steps.version.outputs.version
        id: tag
        run: |
          version="${{ steps.version.outputs.version }}"
          if git rev-parse "$version" >/dev/null 2>&1; then
            echo "created=false" >> "$GITHUB_OUTPUT"
            echo "Tag $version already exists; skipping tagging."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag "$version"
          git push origin "$version"
          echo "created=true" >> "$GITHUB_OUTPUT"

      - name: Update floating tags
        if: steps.version.outputs.version && steps.tag.outputs.created == 'true'
        run: |
          version="${{ steps.version.outputs.version }}"
          major="${version%%.*}"
          minor="${version%.*}"
          for ref in "$major" "$minor"; do
            git tag -f "$ref" "$version"
            git push origin "$ref" --force
          done

      - name: Create GitHub release
        if: steps.version.outputs.version && steps.tag.outputs.created == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          version="${{ steps.version.outputs.version }}"
          gh release create "$version" \
            --target "$GITHUB_SHA" \
            --title "$version" \
            --generate-notes
